<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SwipeBuy - Mobile Header Fix Test</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #00AEEF;
            --primary-color-darker: #0098d4;
            --primary-color-hover: #00c5ff;
            --dark-bg: #121212;
            --card-bg: #1E1E1E;
            --card-bg-lighter: #2a2a2a;
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --border-color: #333333;
            --vignette-color: rgba(0, 0, 0, 0.6);
            --animation-speed-splash: 1.8s;
            --animation-speed-fast: 0.3s;
            --animation-speed-medium: 0.45s; /* Used for pop/shrink */
            --pop-scale: 1.2;
            --adjacent-scale: 0.75;
            --hidden-scale: 0.6;
            --focus-outline-color: var(--primary-color-hover);
            --card-border-radius: 25px;
            --pop-cubic-bezier: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: 100%; /* Ensure html takes full height for body % height to work */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-primary);
            /* overflow: hidden;  <--- REMOVED THIS FOR TESTING HEADER VISIBILITY */
            display: flex;
            flex-direction: column;
            height: 100%; /* Changed from 100vh to 100% to work with html's height */
            min-height: 100vh; /* As a fallback to ensure it at least tries for full viewport */
            -webkit-tap-highlight-color: transparent;
        }

        .app-screen {
            display: none;
            flex-direction: column;
            height: 100%; /* Occupy full height of parent (body or another app-screen if nested) */
            width: 100%;
            animation: screenFadeIn var(--animation-speed-medium) cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .app-screen.active { display: flex; }
        @keyframes screenFadeIn { from { opacity: 0; transform: translateY(15px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

        #splash-screen { justify-content: center; align-items: center; background-color: var(--dark-bg); }
        #splash-screen h1 { font-size: 3.5rem; font-weight: bold; color: var(--primary-color); animation: fadeInSplash var(--animation-speed-splash) cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes fadeInSplash { 0% { opacity: 0; transform: scale(0.6) rotate(-15deg) translateY(50px); } 60% { opacity: 1; transform: scale(1.1) rotate(5deg) translateY(-10px); } 100% { opacity: 1; transform: scale(1) rotate(0deg) translateY(0); } }

        #auth-screen { justify-content: center; align-items: center; padding: 20px; }
        .auth-container { background-color: var(--card-bg); padding: 35px 30px; border-radius: 18px; box-shadow: 0 12px 35px rgba(0,0,0,0.35); width: 100%; max-width: 400px; text-align: center; animation: authContainerAppear 0.6s ease-out 0.1s backwards; }
        @keyframes authContainerAppear { from { opacity: 0; transform: translateY(25px) scale(0.92); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .auth-form-wrapper { overflow: hidden; position: relative; }
        .auth-form-container { animation: authFormSlideIn var(--animation-speed-medium) ease-out; }
        @keyframes authFormSlideIn { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes authFormSlideOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(-30px); } }
        .auth-form-container.exiting { animation: authFormSlideOut var(--animation-speed-medium) ease-in forwards; }
        .auth-container .logo { width: 160px; margin-bottom: 30px; }
        .auth-container h2 { margin-bottom: 25px; color: var(--text-primary); font-size: 1.8rem; }
        .auth-form input { width: 100%; padding: 14px 18px; margin-bottom: 18px; border: 1px solid var(--border-color); background-color: var(--dark-bg); color: var(--text-primary); border-radius: 10px; font-size: 1rem; transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease; }
        .auth-form input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 4px color-mix(in srgb, var(--primary-color) 25%, transparent); transform: scale(1.01); }
        .auth-button { width: 100%; padding: 14px; background-color: var(--primary-color); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; }
        .auth-button:hover { background-color: var(--primary-color-hover); transform: translateY(-3px) scale(1.02); box-shadow: 0 5px 15px rgba(0, 174, 239, 0.3); }
        .auth-button:active { transform: translateY(-1px) scale(0.99); background-color: var(--primary-color-darker); }
        .auth-switch { margin-top: 25px; font-size: 0.95rem; }
        .auth-switch a { color: var(--primary-color); text-decoration: none; font-weight: bold; }
        .forgot-password { display: block; text-align: right; font-size: 0.85rem; margin-top: -12px; margin-bottom: 18px; color: var(--text-secondary); }
        .forgot-password a { color: var(--text-secondary); text-decoration: none; }
        .forgot-password a:hover { text-decoration: underline; color: var(--primary-color); }

        #home-screen {
            /* This ensures the home screen itself is also a flex column taking full height */
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .home-header {
            display: flex;
            align-items: center;
            padding: 10px 15px; /* Adjusted for mobile */
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            min-height: 55px; /* Adjusted for mobile */
            flex-shrink: 0; /* CRITICAL: Prevent header from shrinking */
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        .home-header .logo { height: 30px; margin-right: 10px; } /* Adjusted for mobile */
        .category-filter { background-color: var(--dark-bg); color: var(--text-secondary); border: 1px solid var(--border-color); padding: 6px 8px; border-radius: 6px; font-size: 0.8rem; margin-right: 8px; position: relative; }  /* Adjusted for mobile */
        .category-filter select { background: transparent; color: var(--text-secondary); border: none; outline: none; -webkit-appearance: none; -moz-appearance: none; appearance: none; padding-right: 18px; } /* Adjusted for mobile */
        .category-filter i.fa-chevron-down { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); pointer-events: none; font-size: 0.7rem; } /* Adjusted for mobile */
        .search-bar { flex-grow: 1; display: flex; align-items: center; background-color: var(--dark-bg); border-radius: 20px; padding: 6px 12px; border: 1px solid var(--border-color); transition: border-color 0.3s ease, box-shadow 0.3s ease; } /* Adjusted for mobile */
        .search-bar:focus-within { border-color: var(--primary-color); box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary-color) 20%, transparent); } /* Adjusted for mobile */
        .search-bar input { flex-grow: 1; background: transparent; border: none; color: var(--text-primary); outline: none; font-size: 0.85rem; } /* Adjusted for mobile */
        .search-bar input::placeholder { color: var(--text-secondary); }
        .search-bar i.fa-search { color: var(--text-secondary); font-size: 0.9rem; margin-left: 5px; } /* Adjusted for mobile */
        .profile-icon { margin-left: 10px; font-size: 1.6rem; color: var(--text-secondary); cursor: pointer; transition: color 0.3s ease, transform 0.2s ease; background: none; border: none; padding: 0;} /* Adjusted for mobile */
        .profile-icon i { color: var(--primary-color); transition: color 0.3s ease; }
        .profile-icon:hover i { color: var(--primary-color-hover); }
        .profile-icon:hover { transform: scale(1.1); }

        .swipe-area-wrapper {
            flex-grow: 1; /* CRITICAL: Allows main content to take remaining space */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Prevent its own content from breaking layout */
            position: relative;
            padding: 10px 0; /* Reduced padding for mobile */
            perspective: 1000px;
        }
        #swipe-container { display: flex; align-items: center; position: relative; width: 100%; height: 100%; user-select: none; -webkit-user-select: none; }

        .swipe-item {
            position: absolute; left: 50%; top: 50%;
            width: 70vw; /* Adjusted for mobile, slightly larger relative width */
            max-width: 260px; /* Slightly smaller max for mobile */
            aspect-ratio: 1 / 1.35;
            background-color: var(--card-bg);
            border-radius: var(--card-border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            display: flex; flex-direction: column;
            overflow: hidden;
            transform-style: preserve-3d;
            transition: transform var(--animation-speed-medium) var(--pop-cubic-bezier),
                        opacity var(--animation-speed-medium) ease-in-out,
                        filter var(--animation-speed-medium) ease-in-out,
                        box-shadow var(--animation-speed-medium) ease-in-out;
            cursor: grab; z-index: 1;
            filter: brightness(0.85) saturate(0.85);
            outline: 2px solid transparent;
        }
        .swipe-item:focus-visible { outline-color: var(--focus-outline-color); box-shadow: 0 0 0 4px color-mix(in srgb, var(--focus-outline-color) 30%, transparent); }
        .swipe-item.no-transition { transition: none !important; }
        .swipe-item.grabbing { cursor: grabbing; box-shadow: 0 12px 35px rgba(0,0,0,0.55); }

        .swipe-item-image-container { width: 100%; height: 65%; position: relative; overflow: hidden; background-color: #0a0a0a; border-top-left-radius: var(--card-border-radius); border-top-right-radius: var(--card-border-radius); }
        .swipe-item-image-container::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; box-shadow: inset 0px 0px 50px 15px var(--vignette-color); pointer-events: none; opacity: 0; transition: opacity var(--animation-speed-medium) ease; }
        .swipe-item img { width: 100%; height: 100%; object-fit: cover; display: block; transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.3s ease-in-out; }
        .image-count { position: absolute; top: 10px; left: 10px; background-color: rgba(0,0,0,0.7); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; z-index: 2; font-weight: 500; backdrop-filter: blur(3px); } /* Adjusted for mobile */
        .image-count i { margin-right: 5px; }

        .gallery-controls { position: absolute; top: 50%; left: 0; right: 0; display: flex; justify-content: space-between; transform: translateY(-50%); padding: 0 5px; z-index: 10; pointer-events: none; }
        .gallery-arrow { background-color: rgba(0, 0, 0, 0.4); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease, transform 0.2s ease; pointer-events: all; opacity: 0.7; } /* Adjusted for mobile */
        .gallery-arrow:hover { background-color: rgba(0, 0, 0, 0.7); transform: scale(1.1); opacity: 1; }
        .gallery-arrow:focus-visible { outline: 2px solid var(--primary-color-hover); opacity: 1; }
        .gallery-dots { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; z-index: 10; pointer-events: none; } /* Adjusted for mobile */
        .gallery-dot { width: 7px; height: 7px; background-color: rgba(255, 255, 255, 0.4); border-radius: 50%; cursor: pointer; transition: background-color 0.2s ease, transform 0.2s ease; pointer-events: all; } /* Adjusted for mobile */
        .gallery-dot.active { background-color: white; transform: scale(1.2); }
        .gallery-dot:focus-visible { outline: 2px solid var(--primary-color-hover); background-color: var(--primary-color-hover); }

        .swipe-item-info { padding: 10px 12px; background-color: var(--card-bg); flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; border-bottom-left-radius: var(--card-border-radius); border-bottom-right-radius: var(--card-border-radius); border-top: 1px solid var(--border-color); } /* Adjusted for mobile */
        .swipe-item-info h3 { font-size: 0.95rem; margin-bottom: 3px; color: var(--text-primary); line-height: 1.25; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } /* Adjusted for mobile */
        .swipe-item-info .price { font-size: 0.9rem; font-weight: bold; color: var(--primary-color); margin-bottom: 6px; } /* Adjusted for mobile */
        .buy-button { display: block; width: 100%; padding: 8px; background-color: var(--primary-color); color: white; text-align: center; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: bold; cursor: pointer; margin-top: auto; transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease; } /* Adjusted for mobile */
        .buy-button:hover { background-color: var(--primary-color-hover); transform: scale(1.04); box-shadow: 0 4px 12px rgba(0, 174, 239, 0.25); }
        .buy-button:active { transform: scale(0.98); background-color: var(--primary-color-darker); }
        .buy-button:focus-visible { outline: 2px solid var(--primary-color-hover); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color-hover) 30%, transparent); }

        .swipe-item.current { transform: translate(-50%, -50%) scale(var(--pop-scale)) rotateY(0deg); opacity: 1 !important; z-index: 3; cursor: grab !important; filter: brightness(1) saturate(1) !important; box-shadow: 0 18px 45px rgba(0,0,0,0.6); }
        .swipe-item.current .swipe-item-image-container::after { opacity: 1; }
        .swipe-item.prev { transform: translate(calc(-50% - 40vw), -50%) scale(var(--adjacent-scale)) rotateY(15deg); opacity: var(--adjacent-opacity) !important; z-index: 2; cursor: pointer !important; }
        .swipe-item.next { transform: translate(calc(-50% + 40vw), -50%) scale(var(--adjacent-scale)) rotateY(-15deg); opacity: var(--adjacent-opacity) !important; z-index: 2; cursor: pointer !important; }
        .swipe-item.hidden-left { transform: translate(calc(-50% - 80vw), -50%) scale(var(--hidden-scale)) rotateY(25deg); opacity: 0 !important; pointer-events: none; z-index: 0; }
        .swipe-item.hidden-right { transform: translate(calc(-50% + 80vw), -50%) scale(var(--hidden-scale)) rotateY(-25deg); opacity: 0 !important; pointer-events: none; z-index: 0; }

        .swipe-item.swiping-out-left { animation: swipeOutLeftAnim var(--animation-speed-fast) forwards cubic-bezier(0.6, -0.28, 0.735, 0.045); }
        @keyframes swipeOutLeftAnim { to { transform: translate(-150vw, -50%) scale(0.7) rotateZ(-20deg); opacity: 0; } }
        .swipe-item.swiping-out-right { animation: swipeOutRightAnim var(--animation-speed-fast) forwards cubic-bezier(0.6, -0.28, 0.735, 0.045); }
        @keyframes swipeOutRightAnim { to { transform: translate(50vw, -50%) scale(0.7) rotateZ(20deg); opacity: 0; } }

        .bottom-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0 6px; /* Adjusted for mobile */
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            min-height: 55px; /* Adjusted for mobile */
            flex-shrink: 0; /* CRITICAL: Prevent footer from shrinking */
            box-shadow: 0 -2px 5px rgba(0,0,0,0.15);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-secondary); text-decoration: none; font-size: 0.7rem; cursor: pointer; padding: 4px 6px; transition: color 0.3s ease, transform 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); } /* Adjusted for mobile */
        .nav-item i { font-size: 1.3rem; margin-bottom: 2px; } /* Adjusted for mobile */
        .nav-item.active, .nav-item:hover { color: var(--primary-color); transform: translateY(-3px) scale(1.05); } /* Adjusted for mobile */
        .nav-item:active { transform: translateY(-1px) scale(0.98); }
        .nav-item:focus-visible { outline: 2px solid var(--focus-outline-color); border-radius: 4px; color: var(--primary-color); }
        .visually-hidden { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
    </style>
</head>
<body>
    <div id="splash-screen" class="app-screen active"><h1>SwipeBuy</h1></div>

    <div id="auth-screen" class="app-screen">
        <div class="auth-container">
            <img src="logo.png" alt="SwipeBuy Logo" class="logo" onerror="this.style.display='none'; this.parentElement.insertAdjacentHTML('afterbegin', '<h1 style=\'font-size: 2.5rem; color: var(--primary-color); margin-bottom:25px;\'>SwipeBuy</h1>')">
            <div class="auth-form-wrapper">
                <div id="signup-form-container" class="auth-form-container">
                    <h2>Create Account</h2>
                    <form class="auth-form" onsubmit="event.preventDefault(); showHomeScreen();">
                        <input type="text" placeholder="Username" required aria-label="Username">
                        <input type="email" placeholder="Email" required aria-label="Email">
                        <input type="password" placeholder="Password" required aria-label="Password">
                        <input type="password" placeholder="Confirm Password" required aria-label="Confirm Password">
                        <button type="submit" class="auth-button">Sign Up</button>
                    </form>
                </div>
                <div id="login-form-container" class="auth-form-container" style="display: none;">
                    <h2>Welcome Back!</h2>
                    <form class="auth-form" onsubmit="event.preventDefault(); showHomeScreen();">
                        <input type="text" placeholder="Username or Email" required aria-label="Username or Email">
                        <input type="password" placeholder="Password" required aria-label="Password">
                        <div class="forgot-password">
                            <a href="#" onclick="alert('Forgot Password clicked!')">Forgot Password?</a>
                        </div>
                        <button type="submit" class="auth-button">Login</button>
                    </form>
                </div>
            </div>
            <div class="auth-switch">
                <span id="auth-switch-text">Already have an account? </span>
                <a href="#" id="auth-switch-link" onclick="toggleAuthForms()">Login</a>
            </div>
        </div>
    </div>

    <div id="home-screen" class="app-screen">
        <header class="home-header">
             <img src="logo.png" alt="SwipeBuy" class="logo" onerror="this.style.display='none'; this.parentElement.insertAdjacentHTML('afterbegin', '<h2 style=\'color: var(--primary-color); margin-right:10px; font-size:1.4rem; alt: SwipeBuy;\'>SwipeBuy</h2>');">
            <div class="category-filter">
                <label for="categorySelect" class="visually-hidden">Filter by category</label>
                <select id="categorySelect" aria-label="Filter by category">
                    <option value="all">All</option>
                    <option value="electronics">Electronics</option>
                    <option value="clothes">Clothes</option>
                    <option value="home">Home</option>
                </select>
                <i class="fas fa-chevron-down" aria-hidden="true"></i>
            </div>
            <div class="search-bar">
                <label for="searchInput" class="visually-hidden">Search items</label>
                <input type="text" id="searchInput" placeholder="Search item..." aria-label="Search items">
                <i class="fas fa-search" aria-hidden="true"></i>
            </div>
            <button type="button" class="profile-icon" onclick="alert('Profile clicked!')" aria-label="View Profile">
                <i class="fas fa-user-circle" aria-hidden="true"></i>
            </button>
        </header>

        <main class="swipe-area-wrapper">
            <h2 id="carousel-heading" class="visually-hidden">Product Carousel</h2>
            <div id="swipe-container" role="region" aria-labelledby="carousel-heading" aria-live="polite" tabindex="0">
                </div>
             <p id="carousel-instructions" class="visually-hidden">Use left and right arrow keys to navigate products. Press Enter to buy.</p>
        </main>

        <footer class="bottom-nav" role="navigation" aria-label="Main Navigation">
            <a href="#" class="nav-item active" onclick="handleNavClick(event, 'home')" aria-current="page">
                <i class="fas fa-home" aria-hidden="true"></i> Home
            </a>
            <a href="#" class="nav-item" onclick="handleNavClick(event, 'save')">
                <i class="fas fa-heart" aria-hidden="true"></i> Save
            </a>
            <a href="#" class="nav-item" onclick="handleNavClick(event, 'sell')">
                <i class="fas fa-plus-square" aria-hidden="true"></i> Sell
            </a>
            <a href="#" class="nav-item" onclick="handleNavClick(event, 'message')">
                <i class="fas fa-comment-dots" aria-hidden="true"></i> Message
            </a>
            <a href="#" class="nav-item" onclick="handleNavClick(event, 'cart')">
                <i class="fas fa-shopping-cart" aria-hidden="true"></i> Cart
            </a>
        </footer>
    </div>

    <script>
        const splashScreen = document.getElementById('splash-screen');
        const authScreen = document.getElementById('auth-screen');
        const homeScreen = document.getElementById('home-screen');
        const signupFormContainer = document.getElementById('signup-form-container');
        const loginFormContainer = document.getElementById('login-form-container');
        const authSwitchText = document.getElementById('auth-switch-text');
        const authSwitchLink = document.getElementById('auth-switch-link');

        let isLoginFormVisible = false;
        const swipeContainer = document.getElementById('swipe-container');
        let currentItemIndex = 0;
        let touchstartX = 0;
        let currentDragX = 0;
        let isPointerDown = false;
        const SWIPE_THRESHOLD = 70;
        let swipeInitialized = false;
        let currentGrabbedItem = null;
        // let currentItemInitialX = 0; // Not strictly needed with current transform logic
        let isDragging = false;
        let animationFrameId = null;

        const products = [
            { id: 1, name: "Sleek Wireless Headphones", price: "199.99", images: ["https://images.unsplash.com/photo-1505740420928-5e560c06d30e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8aGVhZHBob25lc3xlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=400&h=400&q=80", "https://images.unsplash.com/photo-1546435770-a3e426bf472b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NXx8aGVhZHBob25lc3xlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=400&h=400&q=80"], category: "electronics" },
            { id: 2, name: "Modern Smartwatch X200", price: "249.00", images: ["https://images.unsplash.com/photo-1546868871-7041f2a55e12?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8c21hcnR3YXRjaHxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=400&h=400&q=80"], category: "electronics" },
            { id: 3, name: "Classic Denim Jacket", price: "79.50", images: ["https://images.unsplash.com/photo-1543076498-1d20249fc7f6?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8ZGVuaW0lMjBqYWNrZXR8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=400&h=400&q=80", "https://images.unsplash.com/photo-1604272908797-39116c409743?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8ZGVuaW0lMjBqYWNrZXR8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=400&h=400&q=80"], category: "clothes" },
            { id: 4, name: "Retro Gaming Console", price: "129.00", images: ["https://images.unsplash.com/photo-1580327344181-c11635415381?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cmV0cm8lMjBnYW1pbmd8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=400&h=400&q=80","https://images.unsplash.com/photo-1593305841991-05c297ba4575?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8cmV0cm8lMjBnYW1pbmd8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=400&h=400&q=80"], category: "electronics"},
            { id: 5, name: "Minimalist Desk Lamp", price: "45.99", images: ["https://images.unsplash.com/photo-1507402313029-7f78934093a9?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8ZGVzayUyMGxhbXB8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=400&h=400&q=80"], category: "home"}
        ];

        function showScreen(screenElement) {
            document.querySelectorAll('.app-screen').forEach(s => s.classList.remove('active'));
            screenElement.classList.add('active');
            if (screenElement === homeScreen && swipeContainer) {
                setTimeout(() => swipeContainer.focus(), 100);
            }
        }

        function toggleAuthForms() {
            const animationSpeed = getAnimationDuration('--animation-speed-medium');
            isLoginFormVisible = !isLoginFormVisible;
            const currentForm = isLoginFormVisible ? signupFormContainer : loginFormContainer;
            const nextForm = isLoginFormVisible ? loginFormContainer : signupFormContainer;
            currentForm.classList.add('exiting');
            setTimeout(() => {
                currentForm.style.display = 'none';
                currentForm.classList.remove('exiting');
                nextForm.style.display = 'block';
                nextForm.classList.remove('exiting');
                authSwitchText.textContent = isLoginFormVisible ? "Don't have an account? " : 'Already have an account? ';
                authSwitchLink.textContent = isLoginFormVisible ? 'Sign Up' : 'Login';
            }, animationSpeed * 0.8);
        }

        function showHomeScreen() {
            showScreen(homeScreen);
            initSwipe();
        }

        function setupImageGallery(itemEl, product) {
            const imageContainer = itemEl.querySelector('.swipe-item-image-container');
            const imgElement = imageContainer.querySelector('img');
            if (!product.images || product.images.length <= 1) {
                const imageCountEl = itemEl.querySelector('.image-count');
                if (imageCountEl) imageCountEl.innerHTML = `<i class="fas fa-camera"></i> ${product.images ? product.images.length : 0}`;
                return;
            }
            const existingImageCount = itemEl.querySelector('.image-count');
            if (existingImageCount) existingImageCount.remove();
            let currentImageIdx = 0;
            imgElement.src = product.images[currentImageIdx];
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'gallery-controls';
            const prevArrow = document.createElement('button');
            prevArrow.className = 'gallery-arrow gallery-prev';
            prevArrow.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevArrow.setAttribute('aria-label', `Previous image for ${product.name}`);
            const nextArrow = document.createElement('button');
            nextArrow.className = 'gallery-arrow gallery-next';
            nextArrow.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextArrow.setAttribute('aria-label', `Next image for ${product.name}`);
            controlsDiv.appendChild(prevArrow);
            controlsDiv.appendChild(nextArrow);
            imageContainer.appendChild(controlsDiv);
            const dotsDiv = document.createElement('div');
            dotsDiv.className = 'gallery-dots';
            dotsDiv.setAttribute('role', 'tablist');
            dotsDiv.setAttribute('aria-label', `Images for ${product.name}`);
            product.images.forEach((_, idx) => {
                const dot = document.createElement('button');
                dot.className = 'gallery-dot';
                dot.dataset.index = idx;
                dot.setAttribute('role', 'tab');
                dot.setAttribute('aria-selected', idx === 0);
                dot.setAttribute('aria-label', `Image ${idx + 1} of ${product.images.length}`);
                dot.addEventListener('click', (e) => { e.stopPropagation(); currentImageIdx = idx; updateGalleryView(); });
                dotsDiv.appendChild(dot);
            });
            imageContainer.appendChild(dotsDiv);
            function updateGalleryView() {
                imgElement.style.opacity = 0;
                setTimeout(() => { imgElement.src = product.images[currentImageIdx]; imgElement.style.opacity = 1; }, 150);
                dotsDiv.querySelectorAll('.gallery-dot').forEach((d, i) => { d.classList.toggle('active', i === currentImageIdx); d.setAttribute('aria-selected', i === currentImageIdx); });
                prevArrow.disabled = currentImageIdx === 0;
                nextArrow.disabled = currentImageIdx === product.images.length - 1;
            }
            prevArrow.addEventListener('click', (e) => { e.stopPropagation(); if (currentImageIdx > 0) { currentImageIdx--; updateGalleryView(); } });
            nextArrow.addEventListener('click', (e) => { e.stopPropagation(); if (currentImageIdx < product.images.length - 1) { currentImageIdx++; updateGalleryView(); } });
            updateGalleryView();
        }

        function createSwipeItemElement(product, index) {
            const itemEl = document.createElement('div');
            itemEl.className = 'swipe-item';
            itemEl.dataset.index = index;
            itemEl.dataset.productId = product.id;
            itemEl.setAttribute('role', 'group');
            itemEl.setAttribute('aria-roledescription', 'product card');
            itemEl.setAttribute('aria-label', product.name);
            itemEl.tabIndex = -1; // Make it focusable programmatically, but not via sequential tab
            const mainImage = product.images && product.images.length > 0 ? product.images[0] : 'https://via.placeholder.com/400x400/CCCCCC/FFFFFF?Text=No+Image';
            itemEl.innerHTML = `
                <div class="swipe-item-image-container">
                    <img src="${mainImage}" alt="${product.name}" draggable="false" loading="lazy">
                    <div class="image-count"><i class="fas fa-camera"></i> ${product.images ? product.images.length : 0}</div>
                </div>
                <div class="swipe-item-info">
                    <div>
                       <h3>${product.name}</h3>
                       <p class="price">$${product.price}</p>
                    </div>
                    <button class="buy-button" data-product-id="${product.id}" data-product-name="${product.name}">Buy Now</button>
                </div>
            `;
            setupImageGallery(itemEl, product);
            itemEl.querySelector('.buy-button').addEventListener('click', (e) => { e.stopPropagation(); alert(`Buy ${e.target.dataset.productName} clicked!`); });
            return itemEl;
        }

        function animateItem(element, { transform, opacity }, duration = 300, easing = 'cubic-bezier(0.25, 0.46, 0.45, 0.94)') {
            return new Promise(resolve => {
                if (!element) { resolve(); return; }
                element.style.transition = `transform ${duration}ms ${easing}, opacity ${duration}ms ease-out`;
                if (transform !== undefined) element.style.transform = transform;
                if (opacity !== undefined) element.style.opacity = opacity;
                setTimeout(() => {
                    // Don't reset transition globally here, it might interfere with other state-based transitions
                    resolve();
                }, duration);
            });
        }

        function renderSwipeItems(focusCurrent = false) {
            if (!swipeContainer) return;
            swipeContainer.innerHTML = '';
            const numProducts = products.length;
            if (numProducts === 0) return;

            const indicesToRender = new Set();
            if (numProducts === 1) { indicesToRender.add(0); }
            else if (numProducts === 2) { indicesToRender.add(0); indicesToRender.add(1); }
            else {
                indicesToRender.add(currentItemIndex);
                indicesToRender.add((currentItemIndex - 1 + numProducts) % numProducts);
                indicesToRender.add((currentItemIndex + 1) % numProducts);
                if (numProducts > 3) {
                    indicesToRender.add((currentItemIndex - 2 + numProducts) % numProducts);
                    indicesToRender.add((currentItemIndex + 2) % numProducts);
                }
            }

            const fragment = document.createDocumentFragment();
            let currentElToFocus = null;

            Array.from(indicesToRender).forEach(idx => {
                const product = products[idx];
                const itemEl = createSwipeItemElement(product, idx);
                itemEl.classList.remove('current', 'prev', 'next', 'hidden-left', 'hidden-right'); // Clear old states

                if (idx === currentItemIndex) {
                    itemEl.classList.add('current');
                    itemEl.tabIndex = 0; // Only current is sequentially focusable
                    currentElToFocus = itemEl;
                } else if (numProducts > 1 && idx === (currentItemIndex - 1 + numProducts) % numProducts) {
                    itemEl.classList.add('prev');
                    itemEl.addEventListener('click', () => navigateItems('prev'), { once: true });
                } else if (numProducts > 1 && idx === (currentItemIndex + 1) % numProducts) {
                    itemEl.classList.add('next');
                    itemEl.addEventListener('click', () => navigateItems('next'), { once: true });
                } else if (numProducts > 2 && idx === (currentItemIndex - 2 + numProducts) % numProducts) {
                    itemEl.classList.add('hidden-left');
                } else if (numProducts > 2 && idx === (currentItemIndex + 2) % numProducts) {
                    itemEl.classList.add('hidden-right');
                }
                fragment.appendChild(itemEl);
            });
            swipeContainer.appendChild(fragment);

            if (focusCurrent && currentElToFocus) {
                setTimeout(() => currentElToFocus.focus(), 50); // Delay focus slightly
                const cardId = `product-card-${currentElToFocus.dataset.productId}`;
                currentElToFocus.id = cardId;
                swipeContainer.setAttribute('aria-activedescendant', cardId);
            }
            const currentProduct = products[currentItemIndex];
            const liveRegion = document.getElementById('carousel-heading');
            if (liveRegion && currentProduct) {
                liveRegion.textContent = `Product Carousel. Current item: ${currentProduct.name}.`;
            }
        }

        async function navigateItems(direction, fromKeyboard = false) {
            if (products.length <= 1 && !fromKeyboard) return;
            const numProducts = products.length;
            const oldCurrentEl = swipeContainer.querySelector('.swipe-item.current');

            if (direction === 'next') {
                currentItemIndex = (currentItemIndex + 1) % numProducts;
            } else if (direction === 'prev') {
                currentItemIndex = (currentItemIndex - 1 + numProducts) % numProducts;
            }

            renderSwipeItems(true); // CSS transitions will handle the pop/shrink

            if (fromKeyboard && oldCurrentEl) { // For keyboard, animate out the old item explicitly if needed
                oldCurrentEl.classList.remove('current');
                oldCurrentEl.tabIndex = -1;
                if (direction === 'next') oldCurrentEl.classList.add('swiping-out-left');
                else oldCurrentEl.classList.add('swiping-out-right');
                // The item will be removed on the next render if it's no longer in indicesToRender
            }
        }

        const onPointerDown = (e) => {
            if (e.target.closest('.gallery-arrow') || e.target.closest('.gallery-dot') || e.target.closest('.buy-button')) { isPointerDown = false; return; }
            currentGrabbedItem = e.target.closest('.swipe-item.current');
            if (!currentGrabbedItem) return;
            swipeContainer.style.touchAction = e.target.closest('.swipe-item-image-container') ? 'pan-x' : 'pan-y';
            isPointerDown = true;
            isDragging = false;
            touchstartX = e.type === 'touchstart' ? e.changedTouches[0].clientX : e.clientX;
            currentDragX = 0;
            currentGrabbedItem.classList.add('grabbing', 'no-transition');
            if (e.type === 'mousedown') e.preventDefault();
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
        };

        const onPointerMove = (e) => {
            if (!isPointerDown || !currentGrabbedItem) return;
            isDragging = true;
            const currentX = e.type === 'touchmove' ? e.changedTouches[0].clientX : e.clientX;
            currentDragX = currentX - touchstartX;
            const baseScale = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--pop-scale'));
            const rotationEffect = currentDragX * 0.05;
            currentGrabbedItem.style.transform = `translate(calc(-50% + ${currentDragX}px), -50%) scale(${baseScale}) rotateZ(${rotationEffect}deg) rotateY(${rotationEffect * 0.5}deg)`;
            currentGrabbedItem.style.opacity = String(1 - Math.abs(currentDragX) / (currentGrabbedItem.offsetWidth));
        };

        const onPointerUp = async (e) => {
            if (!isPointerDown || !currentGrabbedItem) {
                if (currentGrabbedItem) { currentGrabbedItem.classList.remove('grabbing', 'no-transition'); }
                isPointerDown = false; return;
            }
            currentGrabbedItem.classList.remove('grabbing', 'no-transition');
            isPointerDown = false;
            if (!isDragging) {
                currentGrabbedItem.style.transform = ''; currentGrabbedItem.style.opacity = '';
                isDragging = false; currentGrabbedItem = null; return;
            }
            isDragging = false;
            const dragThresholdMet = Math.abs(currentDragX) > SWIPE_THRESHOLD;
            if (dragThresholdMet) {
                const direction = currentDragX < 0 ? 'next' : 'prev';
                let targetX = currentDragX < 0 ? '-100vw' : '100vw';
                let targetRotate = currentDragX < 0 ? -15 : 15;
                await animateItem(currentGrabbedItem, {
                    transform: `translate(calc(-50% + ${targetX}), -60%) scale(0.7) rotateZ(${targetRotate}deg)`,
                    opacity: 0
                }, 300, 'cubic-bezier(0.6, -0.28, 0.735, 0.045)');
                navigateItems(direction); // This will re-render and remove the old item implicitly
            } else {
                currentGrabbedItem.style.transform = ''; // Reset to CSS defined transform for .current
                currentGrabbedItem.style.opacity = ''; // Reset to CSS defined opacity for .current
            }
            currentGrabbedItem = null;
            swipeContainer.style.touchAction = 'pan-y';
        };

        function handleKeyboardNavigation(e) {
            if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'SELECT' || (document.activeElement.tagName === 'BUTTON' && !document.activeElement.closest('.swipe-item')))) { return; }
            const currentFocusedItem = document.activeElement && document.activeElement.closest('.swipe-item.current');
            if (e.key === "ArrowRight") { e.preventDefault(); navigateItems('next', true); }
            else if (e.key === "ArrowLeft") { e.preventDefault(); navigateItems('prev', true); }
            else if (e.key === "Enter" && currentFocusedItem) {
                e.preventDefault();
                const buyButton = currentFocusedItem.querySelector('.buy-button');
                if (buyButton) buyButton.click();
            }
        }

        function initSwipe() {
            if (swipeInitialized || !swipeContainer) {
                if (products.length > 0 && swipeContainer) renderSwipeItems(true);
                return;
            }
            if (products.length === 0) return;
            renderSwipeItems(true);
            swipeContainer.addEventListener('pointerdown', onPointerDown);
            document.addEventListener('pointermove', onPointerMove);
            document.addEventListener('pointerup', onPointerUp);
            document.addEventListener('pointercancel', onPointerUp);
            document.addEventListener('keydown', handleKeyboardNavigation);
            swipeInitialized = true;
        }

        function handleNavClick(event, page) {
            event.preventDefault();
            alert(`${page.charAt(0).toUpperCase() + page.slice(1)} clicked! (Functionality not implemented)`);
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        window.onload = () => {
            const splashDuration = getAnimationDuration('--animation-speed-splash');
            setTimeout(() => showScreen(authScreen), splashDuration);
        };

        function getAnimationDuration(cssVarName, fallback = '0.35s') {
            if (typeof window === 'undefined' || !document.documentElement) return parseFloat(fallback.replace('s',''))*1000;
            const rootStyle = getComputedStyle(document.documentElement);
            const durationStr = rootStyle.getPropertyValue(cssVarName).trim() || fallback;
            return parseFloat(durationStr.replace('s', '')) * 1000;
        }
    </script>
</body>
</html>
