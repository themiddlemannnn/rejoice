<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rejoice ❤️</title>
    <style>
        /* [All previous CSS styles remain exactly the same] */
    </style>
</head>
<body>
    <!-- [All previous HTML structure remains exactly the same] -->

    <!-- Load PeerJS library first -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <script>
        // DOM Elements (same as before)
        const profileSetup = document.getElementById('profile-setup');
        const chatContainer = document.getElementById('chat-container');
        // ... [all other DOM element references remain the same]

        // App State (same as before)
        let myProfile = {
            name: '',
            avatar: ''
        };
        
        let partnerProfile = {
            name: 'My Love',
            avatar: 'data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\' viewBox=\'0 0 100 100\'><circle cx=\'50\' cy=\'40\' r=\'20\' fill=\'%23ff8e9e\'/><circle cx=\'50\' cy=\'100\' r=\'40\' fill=\'%23ff8e9e\'/></svg>'
        };
        
        let messages = JSON.parse(localStorage.getItem('rejoice_chat_messages')) || [];
        let isTyping = false;
        let typingTimeout;
        
        // WebRTC Variables
        let peer;
        let dataChannel;
        let isInitiator = false;
        let roomId = '';

        // Initialize the app after PeerJS is loaded
        function initApp() {
            // Check if profiles are set
            const savedProfile = JSON.parse(localStorage.getItem('rejoice_chat_profile'));
            if (savedProfile) {
                myProfile = savedProfile;
                showChatScreen();
                initPeerConnection();
            }
            
            // Set up event listeners (same as before)
            profileImageContainer.addEventListener('click', () => profileImageInput.click());
            // ... [all other event listeners remain the same]
            
            // Load messages
            renderMessages();
            
            // Add some hearts for fun
            setInterval(createHeart, 3000);
        }

        // Initialize PeerJS connection with secure config for GitHub Pages
        function initPeerConnection() {
            // Create peer connection with secure configuration
            peer = new Peer({
                secure: true,
                host: 'peerjs-server.herokuapp.com',
                port: 443,
                path: '/'
            });
            
            peer.on('open', (id) => {
                updateConnectionStatus('Waiting for connection...');
                
                // Check URL for room ID
                const urlParams = new URLSearchParams(window.location.search);
                roomId = urlParams.get('room') || generateRoomId();
                
                if (!urlParams.get('room')) {
                    isInitiator = true;
                    window.history.pushState({}, '', `?room=${roomId}`);
                    
                    // Create a nicer share message
                    const shareUrl = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
                    const shareMessage = `Share this link with your partner:\n\n${shareUrl}\n\nOr scan this QR code:`;
                    alert(shareMessage);
                    
                    // Generate QR code
                    generateQRCode(shareUrl);
                }
                
                connectToRoom();
            });
            
            peer.on('error', (err) => {
                console.error('Peer error:', err);
                updateConnectionStatus('Connection error', false);
                alert('Connection error. Please refresh the page and try again.');
            });
        }

        // Generate QR code for easy sharing
        function generateQRCode(url) {
            const qrContainer = document.createElement('div');
            qrContainer.id = 'qr-container';
            qrContainer.style.position = 'fixed';
            qrContainer.style.top = '50%';
            qrContainer.style.left = '50%';
            qrContainer.style.transform = 'translate(-50%, -50%)';
            qrContainer.style.backgroundColor = 'white';
            qrContainer.style.padding = '20px';
            qrContainer.style.borderRadius = '10px';
            qrContainer.style.zIndex = '1001';
            qrContainer.style.boxShadow = '0 0 20px rgba(0,0,0,0.3)';
            qrContainer.style.textAlign = 'center';
            
            qrContainer.innerHTML = `
                <p style="margin-bottom: 15px; font-weight: bold;">Scan to join Rejoice</p>
                <canvas id="qr-code"></canvas>
                <button id="close-qr" style="margin-top: 15px; padding: 8px 15px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
            `;
            
            document.body.appendChild(qrContainer);
            
            // Load QR code library dynamically
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js';
            script.onload = () => {
                QRCode.toCanvas(document.getElementById('qr-code'), url, {
                    width: 200,
                    margin: 2
                }, (error) => {
                    if (error) console.error(error);
                });
            };
            document.body.appendChild(script);
            
            // Close button
            document.getElementById('close-qr').addEventListener('click', () => {
                document.body.removeChild(qrContainer);
            });
        }

        function connectToRoom() {
            if (isInitiator) {
                // Create data channel when someone joins
                peer.on('connection', (conn) => {
                    setupDataConnection(conn);
                    updateConnectionStatus('Connected', true);
                    alert('Your partner has joined the chat!');
                });
            } else {
                // Connect to existing room
                const conn = peer.connect(roomId, {
                    reliable: true,
                    serialization: 'json'
                });
                setupDataConnection(conn);
            }
        }

        // [All other functions remain the same as in previous versions...]
        // setupDataConnection, updateConnectionStatus, handleImageUpload, 
        // startChatting, showChatScreen, handleTyping, showTypingIndicator,
        // hideTypingIndicator, handleKeyDown, sendMessage, handleImageSend,
        // addMessage, saveMessages, renderMessages, createMessageElement,
        // formatTime, createHeart, generateRoomId

        // Start the app when PeerJS is loaded
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof Peer !== 'undefined') {
                initApp();
            } else {
                alert('Error: PeerJS library failed to load. Please check your internet connection and refresh the page.');
            }
        });
    </script>
</body>
</html>
